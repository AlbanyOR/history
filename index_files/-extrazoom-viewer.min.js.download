var TOUCH_ENABLE=TOUCH_ENABLE|false;var HTTP_NAME=HTTP_NAME|window.location.protocol+"//"+window.location.hostname;$(function(){});(function(h,b){h.Main=function(p,q,m,o){this.options=$.extend({fullScreen:"",embed:"",animate:"",autohide:"",share:"",info:"",star_rating:"",statistic:"",qr_code:"",contact:"",navigator:true},m);this.resizeTimeout=0;this.navigator;this.embed;this.info;this.indicator=new k($("body"));this.$leftbar;if(o){this.$viewport=p;this.viewport=new Extrazoom.Viewport(p,q,m);var n=this;p.bind("onimagedataloaded",function(){n.setViewport.call(n)}).html("").css("display","none")}else{this.setControls()}};h.Main.prototype={getViewport:function(){return this.viewport},setViewport:function(){var m=this;this.viewport.$div.bind("loadingstart",function(){m.indicator.setBussy.call(m.indicator,true)}).bind("loadingend",function(){m.indicator.setBussy.call(m.indicator,false)});this.viewport.reset();this.$viewport.one("onready",function(){$(this).fadeIn(500,function(){Extrazoom.EventsListeners.add(m.viewport);if(m.options.navigator){m.navigator=new l($("body"),m.viewport);m.setControls()}$(document).bind("keypress.viewport",function(p){var n=p.target.tagName.toLowerCase(),o=p.keyCode;if((o===37|38|39|40)&&n!="input"&&n!="textarea"){p.preventDefault();p.stopPropagation();switch(o){case 39:m.viewport.move.call(m.viewport,m.viewport.hdImage.moveStep,0);break;case 40:m.viewport.move.call(m.viewport,0,m.viewport.hdImage.moveStep);break;case 37:m.viewport.move.call(m.viewport,-m.viewport.hdImage.moveStep,0);break;case 38:m.viewport.move.call(m.viewport,0,-m.viewport.hdImage.moveStep);break}return false}return true})})});$(window).bind("resize orientationchange",function(){clearTimeout(m.resizeTimeout);m.resizeTimeout=setTimeout(function(){m.viewport.hdImage.scaleMin=m.viewport._getMinScale.call(m.viewport);m.viewport.scaleTo.call(m.viewport,m.viewport.hdImage.scaleCurrent,null,true)},200)})},setControls:function(){var m=this;this.$leftbar=$('<div class="leftbar"/>');$("body").append(this.$leftbar);if(screenfull.enabled&&this.options.fullScreen){this.$fs=$('<a class="screenfull ico" title="Fullscreen mode">F</a>');$("body").append(this.$fs);this.$fs.click(function(){if(!screenfull.isFullscreen){screenfull.request()}else{screenfull.exit()}});screenfull.onchange=function(){m.$fs.html(screenfull.isFullscreen?"G":"F")}}if(this.options.embed){this.embed=new d(this.$leftbar)}if(this.options.share){this.share=new i(this.$leftbar)}if(this.options.info){this.info=new g(this.$leftbar,this.options,this.indicator)}this.$leftbar.bind("turned",function(o,n){if(m.embed&&n!=m.embed&&m.embed.enable){m.embed.turnOff()}if(m.share&&n!=m.share&&m.share.enable){m.share.turnOff()}if(m.info&&n!=m.info&&m.info.enable){m.info.turnOff()}});if(this.viewport&&this.viewport.hdImage.src!=""){this.$leftbar.append($('<a href="'+this.viewport.hdImage.baseDir+"/"+this.viewport.hdImage.src+'" target="_blank" class="ico download" title="Download original">I</a>'))}$("body").append('<a href="'+HTTP_NAME+'" target="_new" class="link" title="ExtraZoom - High-resolution images sharing platform"> Published with ExtraZoom </a>');if(this.options.autohide&&!TOUCH_ENABLE){$("body").bind("mousemove",function(n){if(m.navigator){if(n.pageY>$(window).height()-100||m.navigator.enable){$("div.toolbar > a").fadeIn(200)}else{$("div.toolbar > a").fadeOut(200)}}if((n.pageX<100)||(m.info&&m.info.enable)||(m.embed&&m.embed.enable)||(m.share&&m.share.enable)){$("a.embed, a.download, a.share, a.info").fadeIn(200)}else{$("a.embed, a.download, a.share, a.info").fadeOut(200)}if(m.$fs){if(n.pageY<100){$("a.screenfull").fadeIn(200)}else{$("a.screenfull").fadeOut(200)}}})}if(TOUCH_ENABLE){$("body").addClass("touch")}if(SWF_VIEWER){$("a.ico, div.info-panel, div.share-panel, div.embed-panel").bind("mouseover.swf",function(){SWF_VIEWER.cursorToAuto()}).bind("mouseleave.swf",function(){SWF_VIEWER.cursorToType()})}}};var k=function(s){this.$div=$('<div class="indicator"><a href="'+HTTP_NAME+'" target="_new" title="ExtraZoom - High-resolution images sharing platform"></a></div>');s.append(this.$div);var t=12;var p=this.$div.width()/2;for(var o=0;o<t;o++){var m=$('<div class="dot" />');this.$div.append(m);m.css({left:p-m.width()/2+p*Math.cos(2*Math.PI/t*o),top:p-m.height()/2+p*Math.sin(2*Math.PI/t*o),display:"none"})}this.total=t;this.current=0;this.interval=0;this.flag=false;var q=this;this.$div.find("a").hover(function(){$(this).stop().fadeTo(200,1)},function(){$(this).stop().fadeTo(200,q.flag?1:0.5)})};k.prototype={setBussy:function(m){if(m){if(!this.flag){clearInterval(this.interval);var n=this;this.interval=setInterval(function(){var o=n.$div.find("div.dot:eq("+n.current+")").show().stop().fadeOut(800);n.current++;n.current=n.current==n.total?0:n.current},100);this.flag=true}}else{clearInterval(this.interval);this.flag=false}}};var l=function(o,m){var n=this;this.viewport=m;this.enable=false;this.$div=$('<div class="navigator"/>');this.pad=new c(m);this.pad.$div.one("oninit",function(){n.onPadReady.call(n)});this.$slider=null;this.buttons=null;o.append(this.$div)};l.prototype={onPadReady:function(){var o=this,m=this.viewport.hdImage,n=[this.pad.$image.width(),this.pad.$image.height()];this.buttons=new a(this.viewport);this.buttons.$div.bind("turnnavigator",function(r,q){o.$button=$(q);o.turn.call(o)});var p=this.$slider=$('<div class="slider" />');this.$div.css({width:(n[0]+f(2.25+0.5+0.125))+"px",height:(n[1]+f(1.185))+"px"}).append(this.pad.$div).append(this.$slider).hover(function(){o.viewport.$div.unbind("onscale")},function(){o.viewport.$div.bind("onscale",function(){p.slider("set",{cur:m.scaleCurrent})})});p.css({width:f(1.5)+"px",height:(n[1]-f(1.75))+"px",right:f(0.5)+"px",top:f(1.5)+"px"}).slider({min:m.scaleMax,max:m.scaleMin,cur:m.scaleCurrent}).bind("change",function(q,r){o.viewport.scaleTo.call(o.viewport,r);o.viewport.$div.trigger("scaleto",[r])});this.viewport.$div.bind("onscale",function(){p.slider("set",{cur:m.scaleCurrent})}).bind("onready",function(){p.slider("reset",{min:m.scaleMax,max:m.scaleMin,cur:m.scaleCurrent})});j.addFade.call(this)},turn:function(){if(this.enable==true){j.turnOff.call(this)}else{j.turnOn.call(this)}}};var c=function(m){this.size=15;this.$frame=$('<div style="position:absolute;background:white;" class="pad-frame">');this.$image=$('<img style="display:block;position:absolute;left:0px;top:0px">');this.$div=$('<div style="position:absolute;left:0.5em;top:0.5em;" class="pad">');this.viewport=m;var n=m.hdImage;var o=this;this.$image.attr("src",n.baseDir+"/"+n.singleTileDir+"/0_0."+n.format).imagesLoaded(function(){o.onImageLoaded.call(o)});this.$div.append(this.$image).append(this.$frame)};c.prototype={onImageLoaded:function(){var m=this.viewport.hdImage;var n=Math.min(512,f(this.size)),p=m.width/m.height>1?n/m.width:n/m.height,n={width:Math.round(m.width*p)+"px",height:Math.round(m.height*p)+"px"},o=this;this.$image.css(n);this.$div.css(n);this.$frame.css({opacity:0.5});this.setFrame();this._setListener();this.$frame.hover(function(){$(this).parent().css("cursor","pointer")},function(){$(this).parent().css("cursor","default")});this.$frame.mousedown(function(s){s.preventDefault();s.stopPropagation();var q=$(this);var r={dragging:true,delta:[s.pageX-parseInt(q.css("left")),s.pageY-parseInt(q.css("top"))],limits:[Math.max(0,q.parent().width()-q.width()),Math.max(0,q.parent().height()-q.height())]};q.data("drag",r).parent().css("cursor","move");o._unsetListener.call(o);q.parent().bind("mouseleave.pad",function(){o._setListener.call(o);$(this).unbind("mouseleave.pad")})});this.$div.mousemove(function(s){s.preventDefault();var q=$(this).children("div");var r=q.data("drag");if(typeof(r)=="object"&&r.dragging){q.css({left:Math.min(r.limits[0],Math.max(0,s.pageX-r.delta[0])),top:Math.min(r.limits[1],Math.max(0,s.pageY-r.delta[1]))});var u=0-m.width*m.scaleCurrent/parseInt($(this).css("width"))*parseInt(q.css("left")),t=0-m.height*m.scaleCurrent/parseInt($(this).css("height"))*parseInt(q.css("top"));o.viewport.moveTo.call(o.viewport,u,t);o.viewport.$div.trigger("moveto",[u,t])}}).mouseup(function(){o._stopDrag.call(o)}).mouseleave(function(){o._stopDrag.call(o)}).trigger("oninit");this.$image.click(function(x){var r=$(this),t=o.$frame,q=r.width(),s=r.height(),v=Math.max(0,Math.min(x.pageX-r.offset().left-t.width()/2,q-t.width())),u=Math.max(0,Math.min(x.pageY-r.offset().top-t.height()/2,s-t.height()));t.css({left:v+"px",top:u+"px"});o.viewport.moveTo.call(o.viewport,0-m.width*m.scaleCurrent/q*v,0-m.height*m.scaleCurrent/s*u);o._unsetListener.call(o);r.parent().bind("mouseleave.pad",function(){o._setListener.call(o);$(this).unbind("mouseleave.pad")})}).css("cursor","pointer")},_setListener:function(){var m=this;this.viewport.$div.bind("onrender",function(){m.setFrame.call(m)})},_unsetListener:function(){this.viewport.$div.unbind("onrender")},_stopDrag:function(){this.$frame.data("drag",{});this.$div.css("cursor","auto")},setFrame:function(){var m=this.viewport.hdImage;var q=parseInt(this.viewport.pyramid.layers[m.srcLevel].$div.css("left"));var p=parseInt(this.viewport.pyramid.layers[m.srcLevel].$div.css("top"));var s=[0,q,this.viewport.$div.width(),q+m.width*m.scaleCurrent];s.sort(function(u,t){return u-t});var r=[0,p,this.viewport.$div.height(),p+m.height*m.scaleCurrent];r.sort(function(u,t){return u-t});var o=m.width*m.scaleCurrent/this.$image.width();var n=m.height*m.scaleCurrent/this.$image.height();this.$frame.css({left:Math.round(0-Math.min(0,q)/o)+"px",top:Math.round(0-Math.min(0,p)/n)+"px",width:Math.round((s[2]-s[1])/o)+"px",height:Math.round((r[2]-r[1])/n)+"px"})}};var j={turnOn:function(){this.$button.addClass("on");if(this.top){this.$div.css({top:this.top});this.$div.stop().fadeTo(200,1)}else{this.$div.stop().fadeIn();this.top=this.$div.offset().top}this.enable=true},turnOff:function(){var m=this;this.$button.removeClass("on");this.$div.stop().fadeTo(200,0,function(){m.$div.css({top:-1000})});this.enable=false},turn:function(){if(this.enable){this.turnOff()}else{this.turnOn()}this.$parent.trigger("turned",[this])},addFade:function(){var m=this,n=TOUCH_ENABLE?1:0.5;this.$div.css({display:"none",opacity:n}).hover(function(){if(m.enable){$(this).stop().fadeTo("fast",1)}},function(){if(m.enable){$(this).stop().fadeTo("fast",n)}})}};var g=function(p,n,m){this.$parent=p;this.enable=false;this.$div=$('<div class="info-panel"><div class="contents"></div></div>');this.$button=$('<a class="info ico" title="Image information">R</a>');p.append(this.$button);$("body").append(this.$div);this.ready=false;this.options=n;var o=this;this.$button.click(function(){o.turn()});this.indicator=m;j.addFade.call(this);this.messageLabel="Your message...";this.imageUrl=window.location.href.split("?")[0]};g.prototype={turnOn:function(){j.turnOn.call(this);if(!this.ready){this.load();this.indicator.setBussy.call(this.indicator,true)}},turnOff:function(){j.turnOff.call(this)},turn:function(){j.turn.call(this)},load:function(){var m=this;m.ready=true;$.getJSON(HTTP_NAME+"/api/getimageinfo?image_url="+encodeURIComponent(this.imageUrl)+"&type=json&callback=?",function(n){var o=n.record.title?"<h2>"+n.record.title+"</h2>":"<h2>ExtraZoom Image #"+n.record.id+"</h2>";o+=n.record.subtitle?"<h3>"+n.record.subtitle+"</h3>":"";o+=n.record.description?'<p class="descr">'+n.record.description.replace(/\n/g,"<br />")+"</p>":"";o+=n.record.go_for_more_url?'<a href="'+n.record.go_for_more_url+'" class="more" title="Link for more information.\nWill be opened in new window" target="_new">'+n.record.go_for_more_url+"</a>":"";o+=m.options.star_rating?'<div class="raiting"></div>':"";o+=m.options.statistic?'<p class="stat">Size: '+n.record.width+" &times; "+n.record.height+" px <br />Published: "+n.record.added_time+"<br/>Viewed: "+n.record.count+" times</p>":"";o+=m.options.qr_code?'<img class="qr" src="http://qrfree.kaywa.com/?l=1&s=2&d='+encodeURIComponent(m.imageUrl)+'" alt="QR code" />':"";if(n.record.owner&&m.options.contact){if(n.record.message_sent){o+='<span class="contact">Publisher ( '+n.record.owner+" )</span>"}else{o+='<a class="contact">Contact to publisher ( '+n.record.owner+' )</a><div class="form"><p class="sys_message">Fill to send message</p><input class="email" value="Your E-mail address"><textarea class="message">'+m.messageLabel+'</textarea><a class="submit">Send message</a></div>'}}m.$div.children("div.contents").append(o);m.setOverflow.call(m);m.$div.find("a.contact").click(function(){$(this).next().toggle();m.setOverflow.call(m)});if(m.options.star_rating){m.$div.find("div.raiting").starRating({rate:n.record.rate,votes:n.record.votes,url:HTTP_NAME+"/api/rateimage?image_url="+encodeURIComponent(m.imageUrl)+"&type=json&callback=?",enable:n.record.rate_enable})}m.$div.find("a.submit").click(function(){m.submitMessage.call(m)});m.indicator.setBussy.call(m.indicator,false)})},setOverflow:function(){var n=this.$div.children("div.contents");var m=$(window).height()-n.offset().top*2;if(n.height()>m){n.css({height:m})}else{n.scrollBox("unset");n.css({height:"auto"});if(n.outerHeight()<n.parent().height()){n.parent().css({height:n.outerHeight()})}}n.scrollBox()},submitMessage:function(){var p=this,n=$("input.email").val(),o=$("textarea.message").val(),m=/\b[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}\b/im;if(n.match(m)){if(o!=""&&o!=this.messageLabel){this.indicator.setBussy.call(this.indicator,true);$.post(HTTP_NAME+"/api/sendtoowner?image_url="+encodeURIComponent(p.imageUrl)+"&type=json&callback=?",{email:n,message:o,image_url:p.imageUrl},function(q){p.indicator.setBussy.call(p.indicator,false);p.$div.find("p.sys_message").html(q.sys_message);if(q.success){p.$div.find("textarea.message , input.email, a.submit").remove()}},"json")}else{this.$div.find("p.sys_message").html("Please type a message")}}else{this.$div.find("p.sys_message").html("Please fill valid E-mail")}}};var i=function(n){this.$parent=n;this.enable=false;this.$div=$('<div class="share-panel"></div>');this.$button=$('<a class="share ico" title="Share the image">M</a>');n.append(this.$button);$("body").append(this.$div);this.ready=false;var m=this;this.$button.click(function(){m.turn()})};i.prototype={turnOn:function(){j.turnOn.call(this);if(!this.ready){this.load()}},turnOff:function(){j.turnOff.call(this)},turn:function(){j.turn.call(this)},addScript:function(q,m,r,p){var o,n=q.getElementsByTagName(m)[0];if(q.getElementById(r)){return}o=q.createElement(m);o.id=r;o.src=p;n.parentNode.insertBefore(o,n)},load:function(){this.ready=true;var m=this;$("body").prepend('<div id="fb-root"></div>');this.$div.append('<div class="data-row"><div class="fb-like" data-href="'+window.location.href+'" data-send="true" data-layout="button_count" data-width="200" data-show-faces="true" data-font="arial"></div></div>');this.addScript(document,"script","facebook-jssdk","//connect.facebook.net/en_US/all.js#xfbml=1&appId=310017359014594");$.getScript("http://vk.com/js/api/share.js?11",function(){m.$div.append('<div class="data-row">'+VK.Share.button({url:window.location.href},{type:"round",text:"Share"})+"</div>")});this.$div.append('<div class="data-row"><div class="g-plus" data-action="share" data-href="'+window.location.href+'"></div></div>');this.addScript(document,"script","plusone","https://apis.google.com/js/plusone.js");this.$div.append('<div class="data-row"><a href="https://twitter.com/share" class="twitter-share-button" data-url="'+window.location.href+'" data-via="your_screen_name" data-lang="en">Tweet</a><div>');this.addScript(document,"script","twitter-wjs","https://platform.twitter.com/widgets.js")}};var d=function(n){this.$parent=n;this.enable=false;this.initWidth=300;this.initHeight=300;this.$div=$('<div class="embed-panel"><h2>Embedding code</h2><div class="dimentions"><span>Width</span><input type="text" class="width" value="'+this.initWidth+'"><span>Height</span><input type="text" class="height" value="'+this.initHeight+'"></div><textarea id="embedding_code" rows="3" readonly="readonly"></textarea><p class="info">Copy iframe code and past it your page</p><input type="text" class="link" value="'+window.location.href+'" readonly="readonly"><p class="info">Link to the image</p></div>');this.$inputWidth=this.$div.find("input.width");this.$inputHeight=this.$div.find("input.width");var m=this;j.addFade.call(this);this.$div.find("input.width, input.height").change(function(){m.updateCode()});this.$div.find("textarea, input.link").click(function(){this.focus();this.select()});this.$button=$('<a class="embed ico" title="Get embedding code">H</a>');n.append(this.$button);$("body").append(this.$div);this.$button.click(function(){m.turn.call(m)});this.updateCode()};d.prototype={updateCode:function(){var m=parseInt(this.$inputWidth.val());var n=parseInt(this.$inputHeight.val());m=typeof(m)=="number"?Math.max(m,this.initWidth):this.initWidth;n=typeof(n)=="number"?Math.max(n,this.initHeight):this.initHeight;this.$inputWidth.val(m);this.$inputHeight.val(n);$("textarea#embedding_code").val('<iframe src="'+window.location.href+'" width="'+$("div.embed-panel input.width").val()+'" height="'+$("div.embed-panel input.height").val()+'" frameborder="0" allowfullscreen></iframe>')},turnOn:function(){j.turnOn.call(this)},turnOff:function(){j.turnOff.call(this);this.$div.find("input, textarea").trigger("blur")},turn:function(){j.turn.call(this)}};var a=function(m){this.$div=$('<div class="toolbar" />');m.$div.after(this.$div);var q=this,p,o,n=[{name:"Zoom navigator",pic:"E",onclick:function(){q.$div.trigger("turnnavigator",[this])}},{name:"To maximum",pic:"D",onclick:function(){m.scaleTo.call(m,m.hdImage.scaleMax);m.$div.trigger("scaleto",[m.hdImage.scaleMax])}},{name:"Zoom in",pic:"A",onclick:function(){m.scaleUp.call(m);m.$div.trigger("scaleup")}},{name:"Zoom out",pic:"B",onclick:function(){m.scaleDown.call(m);m.$div.trigger("scaledown")}},{name:"To minimum",pic:"C",onclick:function(){m.scaleTo.call(m,m.hdImage.scaleMin);m.$div.trigger("scaleto",[m.hdImage.scaleMin])}}];for(o=0;o<n.length;o++){p=$('<a title="'+n[o].name+'" class="ico">'+n[o].pic+"</a>");p.css({right:(1.25*o)+"em"});(function(r){p.click(n[r].onclick)}(o));this.$div.append(p)}};function e(n,m){var o=function(){};o.prototype=m.prototype;n.prototype=new o();n.prototype.constructor=n;n.uber=m.prototype}function f(o){var m=$('<div style="width:'+o+'em;padding:0px" />');$("body").append(m);var n=m.width();m.remove();return n}})(window.Viewer=window.Viewer||{});(function(a,e){a.Viewport=function(g,i,h){this.$div=g;this.$div.css({overflow:"hidden"}).bind("contextmenu",function(j){return false});this.hdImage=$.extend({width:0,height:0,tileSize:0,overlap:0,format:"",url:"",baseDir:"",singleTileDir:0,leverInit:[0.5,0.5],fillType:"fit",levels:[],scaleFill:0,scaleMin:0,scaleMax:0,scaleCurrent:1,scaleStep:0.7,moveStep:20,leverCurrent:[],srcLevel:1,prevSrcLevel:1,src:"",animate:true},h);this.layerX=0;this.layerY=0;this.animData={};this.dragData={};this.pyramid=null;if(i){this.load(i)}};a.Viewport.prototype={reset:function(){var h=this;this.$div.html("");this.pyramid=new d(this.hdImage,this.$div);this.hdImage.scaleMax=1;this.hdImage.scaleMin=this._getMinScale();this.hdImage.leverCurrent=[this.hdImage.leverInit[0],this.hdImage.leverInit[1]];this.scaleFill=Math.max(this.$div.width()/this.hdImage.width,this.$div.height()/this.hdImage.height);var i=this.hdImage.fillType=="fill"?this.scaleFill:this.hdImage.scaleMin;var g=(this.$div.width()-this.hdImage.width*i)*this.hdImage.leverInit[0];var j=(this.$div.height()-this.hdImage.height*i)*this.hdImage.leverInit[1];this.hdImage.srcLevel=this.hdImage.singleTileDir;this._render(g,j,i,true);this.$div.one("onlayerready",function(k){h.$div.trigger("onready");h._setSrcLevel(i);h._render(g,j,i,true)})},load:function(g){var h=this;this.hdImage.url=g;$.getJSON(HTTP_NAME+"/api/getimagedata?image_url="+encodeURIComponent(g)+"&type=json&callback=?",function(j){h.hdImage.width=parseInt(j.Size.Width);h.hdImage.height=parseInt(j.Size.Height);h.hdImage.tileSize=parseInt(j.TileSize);h.hdImage.overlap=parseInt(j.Overlap);h.hdImage.format=j.Format;h.hdImage.baseDir=j.BaseDir;h.hdImage.singleTileDir=h._getMaxLevel(h.hdImage.tileSize,h.hdImage.tileSize);h.hdImage.src=j.Src;set=h.hdImage.url.split("?");var i=set.pop().match(/s=(h)?(e)?(u)?(l)?(n)?(w)?(?:([0-9]{1,3})x([0-9]{1,3}))?/im);if(i!=null){h.hdImage.leverInit=[parseInt(i[7])/100,parseInt(i[8])/100];h.hdImage.fillType=i[4]?"fill":"fit"}h._setLevels(h.hdImage.width,h.hdImage.height,h.hdImage.tileSize,h.hdImage.tileSize,h.hdImage.overlap);h.$div.trigger("onimagedataloaded")})},move:function(g,i){var h=[this.layerX,this.layerY];this.moveTo(h[0]+g,h[1]+i)},moveTo:function(g,j,h){if(this.hdImage.animate){this._animateStop();this._animateFrom()}var i=new Point(g,j);this._checkLimits(i,this.hdImage.scaleCurrent);this.hdImage.leverCurrent=[i.x/(this.$div.width()-this.hdImage.width*this.hdImage.scaleCurrent),i.y/(this.$div.height()-this.hdImage.height*this.hdImage.scaleCurrent)];if(this.hdImage.animate&&!h){this._animateTo(i.x,i.y,this.hdImage.scaleCurrent)}else{this._render(i.x,i.y,this.hdImage.scaleCurrent,true)}},scaleUp:function(g){this.scaleTo(this.hdImage.scaleCurrent/this.hdImage.scaleStep,g)},scaleDown:function(g){this.scaleTo(this.hdImage.scaleCurrent*this.hdImage.scaleStep,g)},scaleTo:function(i,g,h){if(this.hdImage.animate){this._animateStop();this._animateFrom()}var i=Math.max(this.hdImage.scaleMin,Math.min(i,this.hdImage.scaleMax));if(!g){var j=new Point((this.$div.width()-this.hdImage.width*i)*this.hdImage.leverCurrent[0],(this.$div.height()-this.hdImage.height*i)*this.hdImage.leverCurrent[1])}else{var j=new Point(g[0]-i*(g[0]-this.layerX)/this.hdImage.scaleCurrent,g[1]-i*(g[1]-this.layerY)/this.hdImage.scaleCurrent)}this._setSrcLevel(i);this._checkLimits(j,i);if(this.hdImage.animate&&!h){this._animateTo(j.x,j.y,i)}else{this._render(j.x,j.y,i,true)}},_render:function(m,l,j,t){m=isNaN(m)?0:m;l=isNaN(l)?0:l;var i=new Rectangle(0,0,this.$div.width(),this.$div.height());var q=this.hdImage.tileSize*j/this.hdImage.levels[this.hdImage.srcLevel].scale;var s=[i.x(),m,i.right(),m+this.hdImage.width*j];s.sort(function(v,u){return v-u});var r=[i.y(),l,i.bottom(),l+this.hdImage.height*j];r.sort(function(v,u){return v-u});var p=(i.x()-m)-Math.floor((i.x()-m)/q)*q;var o=(i.y()-l)-Math.floor((i.y()-l)/q)*q;var h=Math.min(Math.ceil((p+s[2]-s[1])/q),this.hdImage.levels[this.hdImage.srcLevel].cols);var k=Math.min(Math.ceil((o+r[2]-r[1])/q),this.hdImage.levels[this.hdImage.srcLevel].rows);var g=Math.max(0,Math.floor((i.x()-m)/q));var n=Math.max(0,Math.floor((i.y()-l)/q));this.layerX=m;this.layerY=l;if(t){this.pyramid.setFgTiles({x:g,y:n,w:h,h:k},this.hdImage.srcLevel)}else{this.pyramid.setBgTiles({x:g,y:n,w:h,h:k},this.hdImage.srcLevel)}this.pyramid.setLayerSizes(Math.round(this.layerX),Math.round(this.layerY),j);if(this.hdImage.scaleCurrent!=j){this.hdImage.scaleCurrent=j;this.$div.trigger("onscale")}this.$div.trigger("onrender")},_animateStop:function(){clearInterval(this.animData.interval);this.animData={}},_animateFrom:function(){this.animData.from={x:this.layerX,y:this.layerY,scale:this.hdImage.scaleCurrent}},_animateTo:function(g,j,i){clearInterval(this.animData.interval);this.animData.to={x:g,y:j,scale:i};this.animData.steps=25;this.animData.step=0;var h=this;this.animData.interval=setInterval(function(){h._animate.call(h)},20)},_animate:function(){var g=false;if(this.animData.step<this.animData.steps){this.animData.step++}else{clearInterval(this.animData.interval);g=true}this._render(this.animData.from.x+Math.round((this.animData.to.x-this.animData.from.x)/this.animData.steps*this.animData.step),this.animData.from.y+Math.round((this.animData.to.y-this.animData.from.y)/this.animData.steps*this.animData.step),this.animData.from.scale+(this.animData.to.scale-this.animData.from.scale)/this.animData.steps*this.animData.step,g)},_dragPrepare:function(h,g){this.dragData.deltaX=h-this.layerX;this.dragData.deltaY=g-this.layerY;this.dragData.ready=true},_checkLimits:function(h,g){if(this.hdImage.width*g>this.$div.width()){h.x=Math.max(Math.min(h.x,0),this.$div.width()-this.hdImage.width*g)}else{this.hdImage.leverCurrent[0]=this.hdImage.leverInit[0];h.x=(this.$div.width()-this.hdImage.width*g)*this.hdImage.leverInit[0]}if(this.hdImage.height*g>this.$div.height()){h.y=Math.max(Math.min(h.y,0),this.$div.height()-this.hdImage.height*g)}else{this.hdImage.leverCurrent[1]=this.hdImage.leverInit[1];h.y=(this.$div.height()-this.hdImage.height*g)*this.hdImage.leverInit[1]}},_setSrcLevel:function(h){this.hdImage.prevSrcLevel=this.hdImage.srcLevel;for(var g=this.hdImage.singleTileDir;g<this.hdImage.levels.length;g++){this.hdImage.srcLevel=g;if(this.hdImage.levels[g].scale>=h){break}}},_getMinScale:function(){return Math.min(Math.min(this.$div.width()/this.hdImage.width,this.$div.height()/this.hdImage.height),this.hdImage.scaleMax)},_getMaxLevel:function(h,g){return Math.ceil(Math.log(Math.max(h,g))/Math.LN2)},_setLevels:function(n,i,p,j,l){var m=this._getMaxLevel(n,i);this.hdImage.levels=[];var k,o,h=1;for(var g=m;g>=0;g--){o=Math.ceil(i/j);k=Math.ceil(n/p);this.hdImage.levels[g]={level:g,rows:o,cols:k,size:[n,i],scale:h,width:n,height:i};n=Math.floor(n/2);i=Math.floor(i/2);h=h/2}}};var d=function(h,j){this.hdImage=h;this.$parent=j;this.layers=[];for(var g=this.hdImage.singleTileDir;g<this.hdImage.levels.length;g++){this.layers[g]=new f(this.hdImage,g,j)}this.stored="";this.fgIndex=0;this.bgIndex=0;this.bgStored=""};d.prototype.setBgTiles=function(j,k){var h=this._setBg(j,k);for(var g=this.hdImage.singleTileDir;g<this.layers.length;g++){if(g!=k&&g!=h){this.layers[g].hide()}}};d.prototype.setFgTiles=function(j,n){if(this.stored!=n+":"+j.x+"-"+j.y+"-"+j.w+"-"+j.h){this.stored=n+":"+j.x+"-"+j.y+"-"+j.w+"-"+j.h;this.$parent.trigger("loadingstart");var g=[],m,h,l=this,i;for(m=0;m<j.h;m++){for(h=0;h<j.w;h++){g.push((j.y+m)+"_"+(j.x+h))}}for(var k in this.layers){this.layers[k].hide()}this.fgIndex=n;if(!this.layers[n].checkIfReady(g)){i=this._setBg(j,n)}this.$parent.one("onlayerready",function(p,q){if(q==l.fgIndex){for(var o=l.hdImage.singleTileDir;o<l.layers.length;o++){if(o!=n&&o!=i){l.layers[o].hide()}}l.$parent.trigger("loadingend")}});this.layers[n].show(g)}};d.prototype._setBg=function(g,j){var i=this;var h=function(p,k){if(k<i.hdImage.singleTileDir){i.layers[i.hdImage.singleTileDir].show(["0_0"]);return i.hdImage.singleTileDir}var q=[],r,l,s,o,m,n;m=Math.floor(p.y/2);n=Math.floor(p.x/2);s=Math.ceil((p.h+p.y%2)/2);o=Math.ceil((p.w+p.x%2)/2);for(r=0;r<s;r++){for(l=0;l<o;l++){q.push((m+r)+"_"+(n+l))}}if(i.layers[k].checkIfReady(q)){i.layers[k].show(q);return k}else{return h({x:n,y:m,w:o,h:s},k-1)}};return h(g,j-1)};d.prototype.setLayerSizes=function(g,j,i){for(var h in this.layers){this.layers[h].$div.css({left:g+"px",top:j+"px"});this.layers[h].scale(i)}};var b=function(j,m,g,n,i,k){this.$img=$("<img />").css({position:"absolute"});this.width=i;this.height=k;this.y=n;this.x=g;this.ready=false;var l=this;this.$img.imagesLoaded(function(){$(this).trigger("ready",[l])}).attr("src",m)};b.prototype.scale=function(g){this.$img.css({left:Math.round(this.x*g)+"px",top:Math.round(this.y*g)+"px"}).attr({width:Math.round(this.width*g)+"px",height:Math.round(this.height*g)+"px"});return this};var f=function(g,i,h){this.hdImage=g;this.$parent=h;this.level=i;this.data=this.hdImage.levels[i];this.$div=$('<div class="layer" style="z-index:'+i+';position:absolute;"></div>');this.scaleLevel=1;h.append(this.$div);this.tiles={};this.theTiles=[]};f.prototype={hide:function(){this.$div.css("display","none")},show:function(h){this.$div.css("display","block");var n=this,m,l,g,j,o,i;this.theTiles=h;for(m in h){if(!this.tiles.hasOwnProperty(h[m])){g=h[m].split("_");o=parseInt(g[1]);i=parseInt(g[0]);j=this.hdImage.tileSize;this.tiles[h[m]]=new b(h[m],this.hdImage.baseDir+"/"+this.level+"/"+h[m]+"."+this.hdImage.format,o*j,i*j,o+1==this.data.cols?this.data.width-o*j:j+this.hdImage.overlap,i+1==this.data.rows?this.data.height-i*j:j+this.hdImage.overlap);this.tiles[h[m]].$img.bind("ready",function(p,k){k.scale.call(k,n.scaleLevel);n.$div.append(k.$img);k.ready=true;n.onShow()})}this.tiles[h[m]].$img.css("display","block")}for(m in this.tiles){if(h.indexOf(m)==-1){this.tiles[m].$img.css("display","none")}}this.onShow()},onShow:function(){for(var g in this.theTiles){if(this.tiles[this.theTiles[g]].ready==false){return false}}this.$parent.trigger("onlayerready",[this.level])},checkIfReady:function(g){for(var h in g){if(!this.tiles[g[h]]||!this.tiles[g[h]].ready){return false}}return true},scale:function(h){var g=h/this.data.scale;if(g!=this.scaleLevel){this.scaleLevel=g;for(prop in this.tiles){this.tiles[prop].scale(this.scaleLevel)}}}};var c={};a.EventsListeners={join:function(g,i,h){var h=h?"."+h:".viewport";i.bind("moveto"+h,function(j){g.moveTo.apply(g,Array.prototype.slice.call(arguments,1))}).bind("scaledown"+h,function(j){g.scaleDown.apply(g,Array.prototype.slice.call(arguments,1))}).bind("scaleup"+h,function(j){g.scaleUp.apply(g,Array.prototype.slice.call(arguments,1))}).bind("scaleto"+h,function(j){g.scaleTo.apply(g,Array.prototype.slice.call(arguments,1))})},remove:function(g){g.$div.css("cursor","default");g.$div.unbind("mousewheel mousedown mousemove mouseleave mouseup tap doubletap dragstart drag transformstart transform")},add:function(g){this.offsetLeft=g.$div.offset().left;this.offsetTop=g.$div.offset().top;var h=this;if(TOUCH_ENABLE){g.$div.hammer({prevent_default:true}).bind("tap",function(i){i.peventDefault();i.stopPropagation();if(typeof(i.position)=="object"){g.scaleTo(g.hdImage.scaleCurrent/g.hdImage.scaleStep,[i.position[0].x-h.offsetLeft,i.position[0].y-h.offsetTop])}}).bind("doubletap",function(i){i.peventDefault();i.stopPropagation();g.scaleTo(g.hdImage.scaleMin,[0,0])}).bind("dragstart",function(i){i.peventDefault();i.stopPropagation();g._dragPrepare(i.position.x,i.position.y)}).bind("drag",function(i){i.peventDefault();i.stopPropagation();g.moveTo(i.position.x-g.dragData.deltaX,i.position.y-g.dragData.deltaY,true)}).bind("transformstart",function(i){i.peventDefault();i.stopPropagation();g.transformStartScale=g.hdImage.scaleCurrent}).bind("transform",function(i){i.peventDefault();i.stopPropagation();g.scaleTo(g.transformStartScale*i.scale,[i.position.x,i.position.y])})}g.$div.css("cursor","pointer").mousedown(function(i){i.preventDefault();i.stopPropagation();g._dragPrepare(i.pageX,i.pageY);$(this).bind("mousemove.viewport",function(k){k.preventDefault();k.stopPropagation();if(g.dragData.ready==true){$(this).css("cursor","move");var m=k.pageX-g.dragData.deltaX,l=k.pageY-g.dragData.deltaY,j=true;g.moveTo(m,l,j);g.dragData.dragging=true;$(this).trigger("moveto",[m,l,j])}})}).mouseleave(function(i){i.preventDefault();i.stopPropagation();if(g.dragData.dragging==true){g.dragData.dragging=false}$(this).css("cursor","pointer");$(this).unbind("mousemove.viewport");g.dragData.ready=false}).mousewheel(function(m,n,j,i){m.preventDefault();m.stopPropagation();var l=m.pageX-$(this).offset().left,k=m.pageY-$(this).offset().top;if(n>0){g.scaleDown.call(g,[l,k]);$(this).trigger("scaledown",[[l,k]])}else{g.scaleUp.call(g,[l,k]);$(this).trigger("scaleup",[[l,k]])}return false}).mouseup(function(m){m.preventDefault();if(g.dragData.ready==true){if(g.dragData.dragging==true){g.dragData.dragging=false}else{if(new Date().valueOf()-c.lastClick<300){clearTimeout(c.timeout);if(m.altKey){g.scaleTo.call(g,g.hdImage.scaleMin,null);$(this).trigger("scaleto",[g.hdImage.scaleMin,null])}else{g.scaleTo.call(g,g.hdImage.scaleMax,null);$(this).trigger("scaleto",[g.hdImage.scaleMax,null])}}else{var n=$(this);var k=m.pageX-n.offset().left;var i=m.pageY-n.offset().top;var j=g.hdImage.scaleCurrent;var l=m.altKey?-1:1;if(m.button&&m.button==2){l=0-l}if(l<0){j*=g.hdImage.scaleStep}else{j/=g.hdImage.scaleStep}c.timeout=setTimeout(function(){g.scaleTo(j,[k,i]);n.trigger("scaleto",[j,[k,i]])},300)}c.lastClick=new Date().valueOf()}$(this).css("cursor","pointer");$(this).unbind("mousemove.viewport");g.dragData.ready=false}})}}})(window.Extrazoom=window.Extrazoom||{});